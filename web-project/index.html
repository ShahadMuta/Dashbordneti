<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة متابعة المنشآت في التقويم</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap');

    body {
      font-family: "Tajawal", sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #2c3e50;
      color: white;
      padding: 15px 30px;
      font-weight: 600;
      font-size: 18px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 30px;
    }

    .title-row h1 {
      margin: 0;
    }

    .title-row .buttons {
      display: flex;
      gap: 10px;
    }

    .buttons button {
      padding: 8px 15px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }

    .print-btn { background-color: #2980b9; }
    .excel-btn { background-color: #27ae60; }

    #subTitle {
      text-align:center;
      font-size:14px;
      color:#555;
      margin-bottom:15px;
    }

    #updateDate {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
      color: #555;
    }

    #totalCenter {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #2980b9;
      margin-bottom: 30px;
    }

    .cards-section {
      margin: 20px auto;
      max-width: 1200px;
    }

    .cards-title {
      font-size: 20px;
      margin-bottom: 10px;
      color: #2c3e50;
      font-weight: 600;
      border-bottom: 2px solid #2980b9;
      padding-bottom: 5px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      padding: 10px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.2s ease;
    }

    .card:hover { transform: scale(1.03); }

    .label { font-size: 16px; margin-bottom: 8px; color: #555; font-weight: 600; }
    .value { font-size: 28px; font-weight: bold; margin-bottom: 8px; }

    .total { color: #2980b9; }
    .success { color: #27ae60; }
    .fail { color: #c0392b; }
    .scheduled { color: #f39c12; }

    #statusMessage {
      text-align: center;
      font-size: 16px;
      color: #c0392b;
      margin-top: 20px;
    }

    canvas { margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>

  <header>أرقام منصة البرنامج الوطني لتقويم التدريب</header>

  <div class="title-row">
    <h1>لوحة متابعة المنشآت في التقويم</h1>
    <div class="buttons">
      <button class="print-btn" onclick="window.print()">طباعة التقرير</button>
      <button class="excel-btn" onclick="exportToExcel()">تصدير Excel</button>
    </div>
  </div>

  <div id="subTitle">عرض إحصائيات يومية للمنشآت</div>
  <div id="updateDate">آخر تحديث: --</div>
  <div id="totalCenter">إجمالي المنشآت: --</div>

  <div class="cards-section">
    <div class="cards-title">التقويم الذاتي</div>
    <div class="cards" id="selfCards"></div>
    <canvas id="selfChart"></canvas>
  </div>

  <div class="cards-section">
    <div class="cards-title">التقويم الخارجي</div>
    <div class="cards" id="externalCards"></div>
    <canvas id="externalChart"></canvas>
  </div>

  <div id="statusMessage"></div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk3Tf3hsS_cGEVvCwm_sQvDI0o1s8luovFadrR6btlanZfzN2Q7plfL1xzsSwEexzUTrrQLhGrxFgo/pub?gid=2128105802&single=true&output=csv";

    async function loadCSV() {
      const statusEl = document.getElementById("statusMessage");
      statusEl.style.color = "#2980b9";
      statusEl.textContent = "جارٍ تحميل البيانات…";

      try {
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error("تعذر تحميل البيانات");

        const data = await response.text();
        const rows = data.split("\n").slice(1);

        const selfContainer = document.getElementById("selfCards");
        const externalContainer = document.getElementById("externalCards");

        selfContainer.innerHTML = "";
        externalContainer.innerHTML = "";

        let totalAll = 0;
        let selfSuccess = 0, selfFail = 0;
        let externalScheduled = 0, externalSuccess = 0, externalFail = 0;

        rows.forEach(row => {
          const cols = row.split(",");
          if (cols.length < 3) return;

          const label = cols[0].trim();
          const value = parseInt(cols[1].trim());
          const type = cols[2].trim();

          if(label === "اجمالي المنشآت في منصة التقويم") totalAll = value;

          const card = document.createElement("div");
          card.className = "card";

          let valueClass = "total";
          if(type === "success") valueClass = "success";
          else if(type === "fail") valueClass = "fail";
          else if(type === "scheduled") valueClass = "scheduled";

          card.innerHTML = `
            <div class="label">${label}</div>
            <div class="value ${valueClass}">${value}</div>
          `;

          if(label.includes("ذاتي")) {
            selfContainer.appendChild(card);
            if(type === "success") selfSuccess = value;
            else if(type === "fail") selfFail = value;
          } else if(label.includes("خارجي") || label.includes("مجدولة") || label.includes("زيارات") || label.includes("غير مجدولين")) {
            externalContainer.appendChild(card);
            if(type === "scheduled") externalScheduled = value;
            else if(type === "success") externalSuccess = value;
            else if(type === "fail") externalFail = value;
          }
        });

        document.getElementById("totalCenter").textContent = `إجمالي المنشآت: ${totalAll}`;
        const now = new Date();
        document.getElementById("updateDate").textContent = `آخر تحديث: ${now.toLocaleString("ar-EG")}`;
        statusEl.textContent = "";

        // رسم بياني ذاتي
        const ctxSelf = document.getElementById('selfChart').getContext('2d');
        new Chart(ctxSelf, {
          type: 'doughnut',
          data: {
            labels: ['أنهت التقويم الذاتي', 'لم تنهي التقويم الذاتي'],
            datasets: [{
              data: [selfSuccess, selfFail],
              backgroundColor: ['#27ae60', '#c0392b'],
            }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        // رسم بياني خارجي
        const ctxExternal = document.getElementById('externalChart').getContext('2d');
        new Chart(ctxExternal, {
          type: 'doughnut',
          data: {
            labels: ['مجدولة', 'زيارات مكتملة', 'غير مجدولين'],
            datasets: [{
              data: [externalScheduled, externalSuccess, externalFail],
              backgroundColor: ['#f39c12', '#27ae60', '#c0392b'],
            }]
          },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

      } catch (error) {
        statusEl.style.color = "#c0392b";
        statusEl.textContent = "تعذر تحميل البيانات";
        console.error(error);
      }
    }

    function exportToExcel() {
      const rows = [];
      document.querySelectorAll('#selfCards .card, #externalCards .card').forEach(card => {
        const label = card.querySelector('.label').textContent;
        const value = card.querySelector('.value').textContent;
        rows.push([label, value]);
      });

      // BOM لتفادي ظهور الرموز العربية
      let csvContent = "\uFEFF"; 
      rows.forEach(r => { csvContent += r.join(",") + "\r\n"; });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      const now = new Date();
      link.download = `تقويم_المنشآت_${now.toLocaleDateString("ar-EG")}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    loadCSV();
  </script>

</body>
</html>
